<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0">
    <style>
      @media screen and (min-width:1001px) and (max-width:1400px){
          .headline{
              display:none;
          }
          #bar{
              display:none;
          }
      }
  </style>
    <title>categorychart</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link rel="stylesheet" href="style.css">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const infoButton = document.getElementById('info');
        infoButton.addEventListener('click', function() {
            alert(' âœ… ì²«í˜ì´ì§€ì˜ ìº˜ë¦°ë”ì— ìˆ˜ì…ê³¼ ì§€ì¶œì„ ê¸°ë¡í•´ìš”.\n âœ… Planì—ì„œëŠ” ì†Œë¹„ì˜ ëª©í‘œì¹˜ë¥¼ ì„¸ìš¸ ìˆ˜ ìˆì–´ìš”.\n âœ… Investë¥¼ ëˆ„ë¥´ë©´ ë¯¸ë˜ë¥¼ ìœ„í•œ ê¸°ë¡ì„ í•  ìˆ˜ ìˆì–´ìš”.');
        });
    });
    </script>
</head>
<body>
    <!--í˜ì´ì§€ ì¢…ë¥˜ í‘œì‹œë°”-->
    <header>
        <div class="container">
            <div class="Rectangle-1">
                <div class="Main-Calender">
                    SelfBook > Plan
                </div>
            </div>
        </div>
    </header>
    <!--ì œëª©-->
    <div class="headline">
        <br><h1>ìŠ¤ìŠ¤ë¡œ ë§Œë“œëŠ” ê°€ê³„ë¶€, ì…€í”„ë¶</h1>
    </div>
<br><hr id="bar"><br>
<nav>
    <div class="container">
        <div class="menu" id="info">Info</div></a>
        <a href="project_Plan.html"><div class="menu">Plan</div></a> 
        <a href="project_Invest.html"><div class="menu">Invest</div></a>
        <a href="project_main.html"><div class="menu">Main</div></a>
    </div>
</nav>
<br><br><br>
<section>
    <br>
    <h4>ğŸ–±ï¸ ì°¨íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ì„œëŠ” ì…ë ¥ì´ í•„ìš”í•´ìš”. </h4>
    <br><br><br>
    <form id="categoryForm">
        <div class="form-group">
            <label for="food">ì‹ë¹„:</label>
            <input type="number" id="food" name="food" min="0" value="0">
        </div>
        <div class="form-group">
            <label for="convenience">í¸ì˜ì /ë§ˆíŠ¸/ì¡í™”:</label>
            <input type="number" id="convenience" name="convenience" min="0" value="0">
        </div>
        <div class="form-group">
            <label for="clothing">ì˜ë¥˜:</label>
            <input type="number" id="clothing" name="clothing" min="0" value="0">
        </div>
        <div class="form-group">
            <label for="other">ê¸°íƒ€:</label>
            <input type="number" id="other" name="other" min="0" value="0">
        </div>
        <button type="button" onclick="saveData()">ì €ì¥</button>
    </form>
      <br><br><br><br>
    <h4>ğŸ–±ï¸ ì°¨íŠ¸ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ì„œ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ëª©í‘œí•œ í¬ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš” </h4>
    <br>
    <div class="container">
        <div class="E1"></div><div class="cg1">ì‹ë¹„</div>
        <div class="E2"></div><div class="cg2">í¸ì˜ì /ë§ˆíŠ¸/ì¡í™”</div>
        <div class="E3"></div><div class="cg1">ì˜ë¥˜</div>
        <div class="E4"></div><div class="cg1">ê¸°íƒ€</div>
    <div class="detail_square"><br>
        <div class="chart-bar" id="chartBar"></div> <br>
        <div class="category_totals" id="categoryTotals"></div>
        <br><br><br>
    <div class="reset">
    <h3>ğŸ“ ìƒˆë¡œìš´ ë‹¬ì—ëŠ”, ìƒˆë¡œìš´ ëª©í‘œë¡œ, ìƒˆë¡­ê²Œ ì‹œì‘í•˜ê¸°--- <button type="button" onclick="resetData()">reset</button></h4>
    </div>
</section>
</body>
<!-- Firebase SDK -->

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";
    import { getAuth, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBsC48vTn3D7sCJHkqBQ2A6wVgkax96IPg",
        authDomain: "selfbook-4ad99.firebaseapp.com",
        databaseURL: "https://selfbook-4ad99-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "selfbook-4ad99",
        storageBucket: "selfbook-4ad99.appspot.com",
        messagingSenderId: "524293661331",
        appId: "1:524293661331:web:3476ad472b7d719ce1a366",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
    if (user) {
        console.log('User is logged in:', user);
        fetchCategoryData(user.uid); // ì‚¬ìš©ì UIDë¥¼ ì „ë‹¬í•˜ì—¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    } else {
        console.log('User is not logged in');
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = 'project_login.html';
    }
});

let foodInput, convenienceInput, clothingInput, otherInput;

window.onload = function() {
  foodInput = document.getElementById('food');
  convenienceInput = document.getElementById('convenience');
  clothingInput = document.getElementById('clothing');
  otherInput = document.getElementById('other');
};

onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = 'project_login.html'; // Redirect to login page if not logged in
    } else {
      console.log('User is logged in:', user);
    }
  });



// ë°ì´í„° ì €ì¥
window.saveData = async function() {
  const user = auth.currentUser;
  if (user) {
    const userId = user.uid; // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°

    // ì…ë ¥ í•„ë“œë“¤ ê°€ì ¸ì˜¤ê¸°
    const foodInput = document.getElementById('food');
    const convenienceInput = document.getElementById('convenience');
    const clothingInput = document.getElementById('clothing');
    const otherInput = document.getElementById('other');

    if (foodInput && convenienceInput && clothingInput && otherInput) {
      let food = parseInt(foodInput.value);
      let convenience = parseInt(convenienceInput.value);
      let clothing = parseInt(clothingInput.value);
      let other = parseInt(otherInput.value);

      const userCategoriesRef = ref(db, `users/${userId}/categories`);
      const snapshot = await get(userCategoriesRef);
      const currentData = snapshot.val() || {};

      // ì´ì „ ê°’ ê°€ì ¸ì˜¤ê¸°
      let previousFood = currentData.food || 0;
      let previousConvenience = currentData.convenience || 0;
      let previousClothing = currentData.clothing || 0;
      let previousOther = currentData.other || 0;

      // í˜„ì¬ ê°’ê³¼ ì´ì „ ê°’ì˜ í•© ê³„ì‚°
      food += previousFood;
      convenience += previousConvenience;
      clothing += previousClothing;
      other += previousOther;

      // ì…ë ¥ëœ ê°’ì´ 0 ì´ìƒì¸ ê²½ìš°ì—ë§Œ ì´ì „ ê°’ìœ¼ë¡œ ì €ì¥
      if (food >= 0) {
        foodInput.setAttribute('data-previous-value', food);
      }

      if (convenience >= 0) {
        convenienceInput.setAttribute('data-previous-value', convenience);
      }

      if (clothing >= 0) {
        clothingInput.setAttribute('data-previous-value', clothing);
      }

      if (other >= 0) {
        otherInput.setAttribute('data-previous-value', other);
      }

      const data = {
        food: food,
        convenience: convenience,
        clothing: clothing,
        other: other
      };

      update(userCategoriesRef, data)
        .then(() => {
          console.log('Data saved successfully.');
        })
        .catch((error) => {
          console.error('Error writing to Firebase:', error);
        });
    } else {
      console.log('Input fields not found.');
    }
  } else {
    console.log('User not logged in.');
  }
};

// ë°ì´í„° ë¦¬ì…‹
window.resetData = async function() {
  const user = auth.currentUser;
  if (user) {
    const userId = user.uid; // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°

    const userCategoriesRef = ref(db, `users/${userId}/categories`);
    
    remove(userCategoriesRef)
      .then(() => {
        console.log('Data reset successfully.');
        // í¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('food').value = 0;
        document.getElementById('convenience').value = 0;
        document.getElementById('clothing').value = 0;
        document.getElementById('other').value = 0;
        updateChart({});
      })
      .catch((error) => {
        console.error('Error resetting data in Firebase:', error);
      });
  } else {
    console.log('User not logged in.');
  }
};

// ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„° ì½ê¸°
function fetchCategoryData(userId) {
  const categoriesRef = ref(db, `users/${userId}/categories`);
  onValue(categoriesRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
          console.log('Data fetched:', data);
          updateChart(data);
      } else {
          console.log('No data available');
      }
  }, (error) => {
      console.error('Error reading from Firebase:', error);
  });
}

// ì°¨íŠ¸ ì—…ë°ì´íŠ¸
function updateChart(data) {
    console.log('Updating chart with data:', data); // ë°ì´í„° í™•ì¸ì„ ìœ„í•œ ë¡œê·¸
    const total = Object.values(data).reduce((sum, value) => sum + value, 0);
    const chartBar = document.getElementById('chartBar');
    const categoryTotals = document.getElementById('categoryTotals');
    chartBar.innerHTML = '';
    categoryTotals.innerHTML = '';

    for (const [category, value] of Object.entries(data)) {
        console.log(`Category: ${category}, Value: ${value}, Width: ${(value / total) * 100}%`); // ê° í•­ëª©ì˜ ë¡œê·¸
        const div = document.createElement('div');
        div.classList.add('chart-item');
        div.classList.add(category);
        div.style.width = `${(value / total) * 100}%`;
        div.setAttribute('data-value', value);
        chartBar.appendChild(div);

        // ê° ì¹´í…Œê³ ë¦¬ì˜ í•©ê³„ë¥¼ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
        const totalText = document.createElement('div');
            totalText.classList.add('category-total-text');
            totalText.textContent = `âœ”ï¸ Total: ${value.toLocaleString()}ì› --- ğŸ’¸${category}`;
            categoryTotals.appendChild(totalText);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
window.onload = () => {
  const user = auth.currentUser;
  if (user) {
      fetchCategoryData(user.uid); // ì‚¬ìš©ì UID ì „ë‹¬
  }
};
</script>
</html>